<!DOCTYPE html>
<html>
    <head>
        <title>Testing FILE UPLOAD</title>
        <link rel="stylesheet" href="style/upload-form.css" />
    </head>
    <body>
        <h1>I wanna test file upload!</h1>
        <div  style="display: box; box-orient: horizontal;">
            <div class="uploadRow">

                <img id="uploadPreview" style="width: 100px; height: 100px; padding:5px;" 
                     src="style/grey-silhouette.png" /><br/>

                <form id="form1" enctype="multipart/form-data" method="post" action="upload.htm" >
                    <label for="fileToUpload">Select a File to Upload</label><br />
                    <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();"/><br/>
                    <input id="uploadButton" disabled="disabled" type="button" 
                           onclick="uploadFile()" value="Upload" />
                    <input id="cancelButton" disabled="disabled" type="button" 
                           onclick="cancelImage()" value="Cancel" />
                    <input id="saveButton" disabled="disabled" type="button" 
                           onclick="saveImage()" value="Save" />
                    <input id="tempImageId" type="hidden" value=""/>
                </form>

            </div>

            <table class="uploadInfo" >
                <tbody>
                    <tr>
                        <th>File name</th>
                        <td id="fileName">-</td>
                    </tr>

                    <tr>
                        <th>File size</th>
                        <td id="fileSize">-</td>
                    </tr>

                    <tr>
                        <th>File type</th>
                        <td id="fileType">-</td>
                    </tr>

                    <tr>
                        <th>Upload progress</th>
                        <td id="progressNumber">not started</td>
                    </tr>

                </tbody>
            </table>
        </div>

        <script>
                        /** Use this function to save the image, after it has been successfully uploaded */
                        function saveImage() {
                            console.log("Trying to save the image!");
                            var dataToSend = new FormData();
                            dataToSend.append('action', 'saveImage');
                            dataToSend.append('tempImageId',
                                    document.getElementById('tempImageId').value);
                            var xhr = new XMLHttpRequest();
                            xhr.open("POST", "upload-save.htm");
                            xhr.send(dataToSend);
//                            alert("Ok!!");
                        }

                        function fileSelected() {
                            var file = document.getElementById('fileToUpload').files[0];
                            if (file) {
                                var fileSize = 0;
                                if (file.size > 1000000)
                                    fileSize = (Math.round(file.size * 100 / (1000000)) / 100).toString() + 'MB';
                                else
                                    fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

                                document.getElementById('fileName').innerHTML = file.name;
                                document.getElementById('fileSize').innerHTML = fileSize;
                                document.getElementById('fileType').innerHTML = file.type;
                                document.getElementById('uploadButton').disabled = false;
                                previewImage();
                            }
                        }

                        function uploadFile() {

                            var xhr = new XMLHttpRequest();
                            var ob = document.getElementById('form1');

                            /* event listners */
                            xhr.upload.addEventListener("progress", uploadProgress, false);
                            xhr.addEventListener("load", uploadComplete, false);
                            xhr.addEventListener("error", uploadFailed, false);
                            xhr.addEventListener("abort", uploadCanceled, false);
                            /* Be sure to change the url below to the url of your upload server side script */
                            xhr.open("POST", "upload.htm");
                            xhr.send(new FormData(ob));
                        }


                        function uploadProgress(evt) {
                            if (evt.lengthComputable) {
                                var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                                document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
                            }
                            else {
                                document.getElementById('progressNumber').innerHTML = 'unable to compute';
                            }
                        }

                        function uploadComplete(evt) {
                            console.log('File upload is complete; response text is: ' +
                                    evt.target.responseText);
                            document.getElementById('cancelButton').disabled = false;
                            document.getElementById('saveButton').disabled = false;
                            document.getElementById('uploadButton').disabled = true;
                            document.getElementById('uploadPreview').src = 'temporary-image-' +
                                    evt.target.responseText + '.htm';
                            document.getElementById('progressNumber').innerHTML = 'uploaded';
                            document.getElementById('tempImageId').value =
                                    evt.target.responseText;

                            // now we need to re-set the preview image as well
//                        alert(evt.target.responseText);
                        }

                        function uploadFailed(evt) {
                            document.getElementById('uploadButton').disabled = true;
                            alert("There was an error attempting to upload the file.");
                        }

                        function uploadCanceled(evt) {
                            document.getElementById('uploadButton').disabled = true;
                            document.getElementById('saveButton').disabled = true;

                            alert("The upload has been canceled by the user or the browser dropped the connection.");
                        }

                        function previewImage() {
                            var fileReader = new FileReader();
                            fileReader.readAsDataURL(document.getElementById('fileToUpload').files[0]);
                            fileReader.onload = function(oFREvent) {
                                document.getElementById('uploadPreview').src = oFREvent.target.result;
                            };
                        }

                        function resetImage() {
                            document.getElementById('uploadPreview').src = 'style/grey-silhouette.png';
                        }

                        function cancelImage() {
                            document.getElementById('form1').reset();
                            document.getElementById('fileName').innerHTML = '-';
                            document.getElementById('fileSize').innerHTML = '-';
                            document.getElementById('fileType').innerHTML = '-';
                            document.getElementById('progressNumber').innerHTML = 'not started';
                            document.getElementById('uploadButton').disabled = false;
                            document.getElementById('cancelButton').disabled = true;
                            document.getElementById('saveButton').disabled = true;
                            resetImage();
                        }
        </script>
    </body>
</html>
